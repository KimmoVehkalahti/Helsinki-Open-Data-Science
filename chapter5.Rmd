---
title: 'Analysis of longitudinal data [DRAFT]'
description: 'Graphical Displays and Summary Measure Approach, Linear Mixed Effects Models for Normal Response Variables'
---

## Meet and Repeat: PART I [DRAFT]

```yaml
type: NormalExercise
key: f9ad1f5b4a
lang: r
xp: 100
skills: 1
```

Welcome to the *Analysis of longitudinal data* chapter.

Many studies in the behavioral sciences involve several measurement or observations of the response variable of interest on each subject in the study. For example, the response variable may be measured under a number of different experimental conditions or on a number of different occasions over time; such data are labelled repeated measures or *longitudinal data*. In the first part (I) of this chapter useful methods for the graphical exploration of this type of data are described and a simple method for their analysis are introduced, with the warning that although simple the method should be used only in the initial stage of dealing with the data; more appropriate methods will be discussed in part II.

Exercise 1 introduction: Check your data

`@instructions`
- Read the `BPRS` data into memory
- Print out the (column) names of the data
- Look at the structure of the data
- Print out summaries of the variables in the data

`@hint`
- Use `str()` to see structure
- Use `summary()` to compute summaries

`@pre_exercise_code`
```{r}

```

`@sample_code`
```{r}
# read the BPRS data
BPRS <- read.table("https://assets.datacamp.com/production/repositories/708/datasets/5346751c337348a8fad84fd239b6b42a730a99c9/BPRS.txt", sep  =" ", header = T)

# look at the (column) names of human
names(BPRS)

# look at the structure of human


# print out summaries of the variables


```

`@solution`
```{r}
# read the BPRS data
BPRS <- read.table("https://assets.datacamp.com/production/repositories/708/datasets/5346751c337348a8fad84fd239b6b42a730a99c9/BPRS.txt", sep  =" ", header = T)

# look at the (column) names of BPRS
names(BPRS)

# look at the structure of BPRS
str(BPRS)

# print out summaries of the variables
summary(BPRS)
```

`@sct`
```{r}

test_function("str", args = "object",incorrect_msg = "Please look at the structure of the BPRS data frame")
test_function("summary", args = "object",incorrect_msg = "Please print out summaries of the variables in the BPRS data frame")

test_error()
success_msg("Awsome, you have mastered an important first step of data analysis!")
```

---

## Graphical displays of longitudinal data: The magical gathering

```yaml
type: NormalExercise
key: e9b52fd18b
lang: r
xp: 100
skills: 1
```

Exercise 2 introduction: Converting to long form

`@instructions`
- Factor treatment and subject from BPRS
- Gather by key = weeks by excluding treatment and subject (how does key work?)
- Mutate a new integer variable week by substringing the only week number
- Glimpse

`@hint`
- Hints

`@pre_exercise_code`
```{r}
library(dplyr); library(tidyr)
BPRS <- read.table("https://assets.datacamp.com/production/repositories/708/datasets/5346751c337348a8fad84fd239b6b42a730a99c9/BPRS.txt", sep  =" ", header = T)
```

`@sample_code`
```{r}
# dplyr & tidyr packages and BPRS are available

```

`@solution`
```{r}
# dplyr & tidyr packages and BPRS are available

# Factor treatment & subject
BPRS$treatment <- factor(BPRS$treatment)
BPRS$subject <- factor(BPRS$subject)

# Convert to long form
BPRSL <-  BPRS %>% gather(key = weeks, value = bprs, -treatment, -subject)
BPRSL <-  BPRSL %>% mutate(week = as.integer(substr(weeks,5,5)))

# Let's see the gathered "long" data
glimpse(BPRSL)
```

`@sct`
```{r}

success_msg("No tests yet!")
```

---

## Graphical displays of longitudinal data: Individual plots

```yaml
type: NormalExercise
key: a1be9da8e9
lang: r
xp: 100
skills: 1
```

Exercise 3 introduction

`@instructions`
- Draw the first plot
- Standardise variable bprs
- Glimpse
- Draw a new plot of the standardised values

`@hint`
- Hints

`@pre_exercise_code`
```{r}
library(dplyr); library(tidyr); library(ggplot2)
BPRS <- read.table("https://assets.datacamp.com/production/repositories/708/datasets/5346751c337348a8fad84fd239b6b42a730a99c9/BPRS.txt", sep  =" ", header = T)
BPRS$treatment <- factor(BPRS$treatment)
BPRS$subject <- factor(BPRS$subject)
BPRSL <-  BPRS %>% gather(key = weeks, value = bprs, -treatment, -subject)
BPRSL <-  BPRSL %>% mutate(week = as.integer(substr(weeks,5,5)))
rm(BPRS)
```

`@sample_code`
```{r}
# dplyr, tidyr & ggplot2 packages and BPRSL are available

```

`@solution`
```{r}
# dplyr, tidyr & ggplot2 packages and BPRSL are available

# Plot me! (maybe do this in a function)
p1 <- ggplot(BPRSL, aes(x = week, y = bprs, linetype = subject))
p2 <- p1 + geom_line() + scale_linetype_manual(values = rep(1:10, times=4))
p3 <- p2 + facet_grid(. ~ treatment, labeller = label_both)
p4 <- p3 + theme_bw() + theme(legend.position = "none")
p5 <- p4 + scale_y_continuous(limits = c(min(BPRSL$bprs), max(BPRSL$bprs)))
p5

# Standardise

BPRSL <- BPRSL %>%
  group_by(week) %>%
  mutate( stdbprs = (bprs - mean(bprs))/sd(bprs) ) %>%
  ungroup()

# Check what's new
glimpse(BPRSL)

# Plot again
p1 <- ggplot(BPRSL, aes(x = week, y = stdbprs, linetype = subject))
p2 <- p1 + geom_line() + scale_linetype_manual(values = rep(1:10, times=4))
p3 <- p2 + facet_grid(. ~ treatment, labeller = label_both)
p4 <- p3 + theme_bw() + theme(legend.position = "none")
p5 <- p4 + scale_y_continuous(name = "standardized bprs")
p5

```

`@sct`
```{r}

success_msg("No tests yet!")
```

---

## Graphical displays of longitudinal data: Summary graphs

```yaml
type: NormalExercise
key: 4825d6d5aa
lang: r
xp: 100
skills: 1
```

Exercise 4 introduction

`@instructions`
- Create summary data BPRSS w/ vars mean & standard error
- Glimpse
- Draw a line plot of means and standard errors by treatment

`@hint`
- Hints

`@pre_exercise_code`
```{r}
library(dplyr); library(tidyr); library(ggplot2)
BPRS <- read.table("https://assets.datacamp.com/production/repositories/708/datasets/5346751c337348a8fad84fd239b6b42a730a99c9/BPRS.txt", sep  =" ", header = T)
BPRS$treatment <- factor(BPRS$treatment)
BPRS$subject <- factor(BPRS$subject)
BPRSL <-  BPRS %>% gather(key = weeks, value = bprs, -treatment, -subject)
BPRSL <-  BPRSL %>% mutate(week = as.integer(substr(weeks,5,5)))
rm(BPRS)
BPRSL <- BPRSL %>%
  group_by(week) %>%
  mutate( stdbprs = (bprs - mean(bprs))/sd(bprs) ) %>%
  ungroup()
```

`@sample_code`
```{r}
# dplyr, tidyr & ggplot2 packages and BPRSL are available

```

`@solution`
```{r}
# dplyr, tidyr & ggplot2 packages and BPRSL are available

# Make a summary data:

# Number of weeks, baseline (0) included
n <- BPRSL$week %>% unique() %>% length()
BPRSS <- BPRSL %>%
  group_by(treatment, week) %>%
  summarise( mean=mean(bprs), se=sd(bprs)/sqrt(n) ) %>%
  ungroup()

glimpse(BPRSS)

# Give something beforhand but let student add some layers
p1 <- ggplot(BPRSS, aes(x = week, y = mean, linetype = treatment, shape = treatment))
p2 <- p1 + geom_line() + scale_linetype_manual(values = c(1,2))
p3 <- p2 + geom_point(size=3) + scale_shape_manual(values = c(1,2))
# for example fill ymax and ymin
p4 <- p3 + geom_errorbar(aes(ymin=mean-se, ymax=mean+se, linetype="1"), width=0.3)
p5 <- p4 + theme(legend.position = c(0.8,0.8))
p6 <- p5 + scale_y_continuous(name = "mean(bprs) +/- se(bprs)")
p6

```

`@sct`
```{r}

success_msg("No tests yet!")
```

---

## Graphical displays of longitudinal data: Find the outlaw

```yaml
type: NormalExercise
key: 1f43aab223
lang: r
xp: 100
skills: 1
```

Exercise 5 introduction

`@instructions`
- Create summary data BPRSL8S
- Glimpse
- Draw a boxplot
- Seek and destroy the outlier
- Plot again

`@hint`
- Hints

`@pre_exercise_code`
```{r}
library(dplyr); library(tidyr); library(ggplot2)
BPRS <- read.table("https://assets.datacamp.com/production/repositories/708/datasets/5346751c337348a8fad84fd239b6b42a730a99c9/BPRS.txt", sep  =" ", header = T)
BPRS$treatment <- factor(BPRS$treatment)
BPRS$subject <- factor(BPRS$subject)
BPRSL <-  BPRS %>% gather(key = weeks, value = bprs, -treatment, -subject)
BPRSL <-  BPRSL %>% mutate(week = as.integer(substr(weeks,5,5)))
rm(BPRS)
BPRSL <- BPRSL %>%
  group_by(week) %>%
  mutate( stdbprs = (bprs - mean(bprs))/sd(bprs) ) %>%
  ungroup()
```

`@sample_code`
```{r}
# dplyr, tidyr & ggplot2 packages and BPRSL are available

```

`@solution`
```{r}
# dplyr, tidyr & ggplot2 packages and BPRSL are available

BPRSL8S <- BPRSL %>%
  filter(week > 0) %>%
  group_by(treatment, subject) %>%
  summarise( mean=mean(bprs) ) %>%
  ungroup()

glimpse(BPRSL8S)

p1 <- ggplot(BPRSL8S, aes(x = treatment, y = mean))
p2 <- p1 + geom_boxplot()
#p3 <- p2 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p3 <- p2 + stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "white")
p4 <- p3 + scale_y_continuous(name = "mean(bprs), weeks 1-8")
p4

# Remove the outlier:

BPRSL8S1 <- BPRSL8S %>%
  filter(mean < 60)

glimpse(BPRSL8S1)

# Figure 8.6 - without the outlier:

p1 <- ggplot(BPRSL8S1, aes(x = treatment, y = mean))
p2 <- p1 + geom_boxplot()
#p3 <- p2 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p3 <- p2 + stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "white") # other color?
p4 <- p3 + scale_y_continuous(name = "mean(bprs), weeks 1-8")
p4

```

`@sct`
```{r}

success_msg("No tests yet!")
```

---

## Graphical displays of longitudinal data: T-test and anova

```yaml
type: NormalExercise
key: 692af7cc51
lang: r
xp: 100
skills: 1
```

Exercise 6 introduction

`@instructions`
- inst

`@hint`
- Hints

`@pre_exercise_code`
```{r}
library(dplyr); library(tidyr); library(ggplot2)
BPRS <- read.table("https://assets.datacamp.com/production/repositories/708/datasets/5346751c337348a8fad84fd239b6b42a730a99c9/BPRS.txt", sep  =" ", header = T)
BPRS$treatment <- factor(BPRS$treatment)
BPRS$subject <- factor(BPRS$subject)
BPRSL <-  BPRS %>% gather(key = weeks, value = bprs, -treatment, -subject)
BPRSL <-  BPRSL %>% mutate(week = as.integer(substr(weeks,5,5)))
BPRSL <- BPRSL %>%
  group_by(week) %>%
  mutate( stdbprs = (bprs - mean(bprs))/sd(bprs) ) %>%
  ungroup()
BPRSL8S <- BPRSL %>%
  filter(week > 0) %>%
  group_by(treatment, subject) %>%
  summarise( mean=mean(bprs) ) %>%
  ungroup()
rm(BPRSL)
BPRSL8S1 <- BPRSL8S %>%
  filter(mean < 60)
```

`@sample_code`
```{r}
# dplyr, tidyr & ggplot2 packages, BPRSL8S and BPRSL8S1 are available

```

`@solution`
```{r}
# dplyr, tidyr & ggplot2 packages, BPRSL8S and BPRSL8S1 are available

t.test(mean ~ treatment, data = BPRSL8S1, var.equal = TRUE)


# Table 8.4

# Add the baseline from the original data as a new variable to the summary data:
baseline <- BPRS$week0
BPRSL8S2 <- BPRSL8S %>%
  mutate(baseline)

# Fit the ancova model and see the results:

fit <- lm(mean ~ baseline + treatment, data = BPRSL8S2)

summary(fit)
anova(fit)

```

`@sct`
```{r}

success_msg("No tests yet!")
```

---

## Meet and Repeat: PART II

```yaml
type: NormalExercise
lang: r
xp: 100
skills: 1
key: 029bd37f33
```

Welcome to the PART II of *Analysis of longitudinal data* chapter.

Longitudinal data, where a response variable is measured on each subject on several different occasions poses problems for their analysis because the repeated measurements on each subject are very likely to be correlated rather than independent. In PART II of this chapter methods for dealing with longitudinal data which aim to account for the correlated nature of the data and where the response is assumed to be normally distributed are discussed, and then applied to several sets of data including a study of the use of computerized delivery of cognitive behavioral therapy.

Exercise 7 introduction: Rats!!

`@instructions`
- Read the `RATS` data into memory

`@hint`
- Use `str()` to see structure
- Use `summary()` to compute summaries

`@pre_exercise_code`
```{r}
library(dplyr)
```

`@sample_code`
```{r}
# dplyr is available

# read the RATS data

```

`@solution`
```{r}
# dplyr is available

# read the RATS data
RATS <- read.table("http://assets.datacamp.com/production/repositories/708/datasets/9475c75ae0ffa340f53ef895e2494b256774a1d6/rats.txt", header = TRUE, sep = '\t')

RATS$ID <- factor(RATS$ID)
RATS$Group <- factor(RATS$Group)

glimpse(RATS)

pairs(RATS[, 3:13], cex = 0.7)

```

`@sct`
```{r}

success_msg("No tests yet!")
```

---

## Linear Mixed Effects Models: Gather 'round

```yaml
type: NormalExercise
lang: r
xp: 100
skills: 1
key: ee47059b42
```

Exercise 8 introduction

`@instructions`
- Instructions

`@hint`
- Hint

`@pre_exercise_code`
```{r}
library(dplyr); library(tidyr)
RATS <- read.table("http://assets.datacamp.com/production/repositories/708/datasets/9475c75ae0ffa340f53ef895e2494b256774a1d6/rats.txt", header = TRUE, sep = '\t')
RATS$ID <- factor(RATS$ID)
RATS$Group <- factor(RATS$Group)
```

`@sample_code`
```{r}
# dplyr, tidyr and RATS are available

# Convert data to long form:

```

`@solution`
```{r}
# dplyr, tidyr and RATS are available

# Convert data to long form:

RATSL <- gather(RATS, key = WD, value = Weight, -ID, -Group) %>%
  mutate(Time = as.integer(substr(WD,3,4))) 

glimpse(RATSL)
head(RATSL)
tail(RATSL)

```

`@sct`
```{r}

success_msg("No tests yet!")
```